{% extends "base_bootstrap.html" %}
{% load i18n %}
{% block title %}{{ block.super }}{% trans "Pridėti instrukciją" %}{% endblock title %}
{% block content %}
<div class="container-fluid py-4">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4 class="mb-0"><i class="bi bi-plus-circle me-2"></i>{% trans "Pridėti instrukciją/ -as vartotojams" %}</h4>
        </div>
        <div class="card-body">
    <form method="POST">
        {% csrf_token %}
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="id_position" class="form-label">{% trans "Pareigos:" %}</label>
                {{ form.position }}
            </div>
            <div class="col-md-4">
                <label for="id_skyrius" class="form-label">{% trans "Skyrius:" %}</label>
                {{ form.skyrius }}
            </div>
            <div class="col-md-4">
                <label for="id_kalba" class="form-label">
                    {% trans "Darbuotojui suprantama kalba:" %}
                    <i class="bi bi-info-circle text-primary ms-1" data-bs-toggle="tooltip"
                       title="{% trans 'Pasirinkus kalbą, bus rodomi tik tos kalbos darbuotojai' %}"></i>
                </label>
                {{ form.kalba }}
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="id_instructions" class="form-label">
                    {% trans "Darbų saugos instrukcijos:   " %}
                    <i class="bi bi-info-circle text-primary ms-1" data-bs-toggle="tooltip"
                       title="Paspaudę žemiau esančią lentelę ir pasirinkite norimus dokumentus."></i>
                </label>
                <div class="form-group">
                    {{ form.instructions }}
                </div>
            </div>
            <div class="col-md-6">
                <label for="id_priesgaisrines" class="form-label">
                    {% trans "Priesgaisrinės instrukcijos:   " %}
                    <i class="bi bi-info-circle text-primary ms-1" data-bs-toggle="tooltip"
                       title="Paspaudę žemiau esančią lentelę ir pasirinkite norimus dokumentus."></i>
                </label>
                {{ form.priesgaisrines }}
            </div>
        </div>mt-4">
            <button class="btn btn-primary" type="submit">
                <i class="bi bi-check-circle me-2"></i>{% trans "Patvirtinti" %}
            </button>
            <a class="btn btn-secondary" href="{% url "my_company_users" %}">
                <i class="bi bi-arrow-left me-2"></i>{% trans "Atgal" %}
            </a>
        </div>
    </form>
        </div>
    </div>
                {% trans "Civilinės saugos instrukcijos:   " %}
                    <i class="bi bi-info-circle text-primary ms-1" data-bs-toggle="tooltip"
                       title="Paspaudę žemiau esančią lentelę ir pasirinkite norimus dokumentus."></i>
                </label>
                {{ form.civiline_sauga }}
            </div>
            <div class="col-md-6">
                <label for="id_mokymai" class="form-label">
                    {% trans "Mokymai:   " %}
                    <i class="bi bi-info-circle text-primary ms-1" data-bs-toggle="tooltip"
                       title="Paspaudę žemiau esančią lentelę ir pasirinkite norimus dokumentus."></i>
                </label>
                {{ form.mokymai }}
            </div>
        </div>
        
        <div class="row mb-3">
            <div class="col-md-6">
                <label for="id_kiti_dokumentai" class="form-label">
                    {% trans "Kiti dokumentai:   " %}
                    <i class="bi bi-info-circle text-primary ms-1" data-bs-toggle="tooltip"
                       title="Paspaudę žemiau esančią lentelę ir pasirinkite norimus dokumentus."></i>
                </label>
                {{ form.kiti_dokumentai }}
            </div>
        </div>
        <div class="horizontal_container" style="justify-content: center;">
        <button class="button" type="post">{% trans "Patvirtinti" %}</button>
        <a class="button" href="{% url "my_company_users" %}">{% trans "Atgal" %}</a>
        </div>
    </form><br><br>
    </div>
{% endblock content %}
    {% block extrajs %}

<!-- In your <head> or before </body> -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const langSelect = document.getElementById('id_kalba');
    const instructionsSelect = document.getElementById('id_instructions');
    // Get assigned instructions from Django context
    const assignedInstructions = {{ assigned_instructions|safe }};

    function updateOptions(select, items, assigned) {
        if (!select) return;
        select.innerHTML = '';
        items.forEach(function(item) {
            const option = document.createElement('option');
            option.value = item.id;
            option.text = item.name;
            if (assigned.includes(item.id)) {
                option.selected = true;
            }
            select.appendChild(option);
        });
    }

    if (langSelect) {
        langSelect.addEventListener('change', function () {
            fetch(`/get_instructions_by_language/?kalba=${langSelect.value}`)
                .then(response => response.json())
                .then(data => {
                    updateOptions(instructionsSelect, data.instructions, assignedInstructions);
                    updateOptions(priesgaisrinesSelect, data.priesgaisrines, assignedPriesgaisrines);
                    updateOptions(civilineSaugaSelect, data.civiline_sauga, assignedCivilineSauga);
                    updateOptions(mokymaiSelect, data.mokymai, assignedMokymai);
                    updateOptions(kitiDokumentaiSelect, data.kiti_dokumentai, assignedKitiDokumentai);
                    updateOptions(AsmeninesApsaugosPriemonesSelect, data.AsmeninesApsaugosPriemones, assignedAsmeninesApsaugosPriemones);
                });
        });
    }


});
</script>
<script>
$(document).ready(function() {
    $.fn.select2.defaults.set('language', {
        noResults: function() {
            return "Rezultatų nėra";
        }
    });

    $('#id_position').addClass('form-select');
    $('#id_skyrius').addClass('form-select');
    $('#id_kalba').addClass('form-select');
    
    $('#id_instructions').select2({
        width: '100%',
        placeholder: "Pasirinkite darbų saugos instrukcijas",
        allowClear: true
    });
    $('#id_priesgaisrines').select2({
        width: '100%',
        placeholder: "Pasirinkite priesgaisrines instrukcijas",
        allowClear: true
    });
    $('#id_civiline_sauga').select2({
        width: '100%',
        placeholder: "Pasirinkite civilines saugos instrukcijas",
        allowClear: true
    });
    $('#id_mokymai').select2({
        width: '100%',
        placeholder: "Pasirinkite mokymo instrukcijas",
        allowClear: true
    });
    $('#id_kiti_dokumentai').select2({
        width: '100%',
        placeholder: "Pasirinkite kitus dokumentus",
        allowClear: true
    });
    $('#id_AsmeninesApsaugosPriemones').select2({
        width: '100%',
        placeholder: "Pasirinkite asmenines apsaugos priemones",
        allowClear: true
    });
    
    // Initialize Bootstrap tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock extrajs %}