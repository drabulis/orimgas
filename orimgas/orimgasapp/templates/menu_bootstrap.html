{% extends 'base_bootstrap.html' %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "Pagrindinis" %} - Orimgas{% endblock %}

{% block content %}
<style>
    /* Responsive PDF viewer - larger on mobile/tablet */
    .pdf-viewer-responsive {
        height: 600px;
    }
    
    /* Tablets and below - fullscreen with better PDF height */
    @media (max-width: 991px) {
        .pdf-viewer-responsive {
            height: 70vh;
        }
    }
    
    /* Mobile devices - fullscreen with optimized height */
    @media (max-width: 576px) {
        .pdf-viewer-responsive {
            height: 65vh;
        }
    }
</style>

<div class="container-fluid py-4">
    <!-- Welcome Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h2 class="mb-2">{% trans "Sveiki" %}, {{ user.first_name }} {{ user.last_name }}!</h2>
                            <p class="text-muted mb-1">
                                <i class="bi bi-envelope"></i> {{ user.email }}
                            </p>
                            <p class="text-muted mb-1">
                                <i class="bi bi-building"></i> {{ user.company.name }}
                                {% if user.position %}
                                    | <i class="bi bi-briefcase"></i> {{ user.position.name }}
                                {% endif %}
                                {% if user.skyrius %}
                                    | <i class="bi bi-diagram-3"></i> {{ user.skyrius.pavadinimas }}
                                {% endif %}
                            </p>
                            {% if user.date_of_birth %}
                            <p class="text-muted mb-1">
                                <i class="bi bi-calendar3"></i> {% trans "Gimimo data" %}: {{ user.date_of_birth }}
                            </p>
                            {% endif %}
                            {% if user.med_patikros_data or user.sekanti_med_patikros_data %}
                            <p class="text-muted mb-0">
                                {% if user.med_patikros_data %}
                                    <i class="bi bi-heart-pulse"></i> {% trans "Paskutinė med. patikra" %}: {{ user.med_patikros_data }}
                                {% endif %}
                                {% if user.sekanti_med_patikros_data %}
                                    | {% trans "Kita patikra" %}: {{ user.sekanti_med_patikros_data }}
                                {% endif %}
                                {% if user.med_patikros_periodas %}
                                    | {% trans "Periodiškumas (mėn.)" %}: {{ user.med_patikros_periodas }}
                                {% endif %}
                            </p>
                            {% endif %}
                        </div>
                        <div class="text-end d-none d-md-block">
                            <a href="{% url 'user_edit' user.uuid %}" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-key"></i> {% trans "Keisti slaptažodį" %}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Row -->
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card stat-card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">{% trans "Viso instrukcijų" %}</h6>
                            <h3 class="mb-0">{{ total_instructions }}</h3>
                        </div>
                        <div class="text-primary">
                            <i class="bi bi-file-text" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card stat-card success">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">{% trans "Pasirašyta" %}</h6>
                            <h3 class="mb-0 text-success">{{ signed_instructions }}</h3>
                        </div>
                        <div class="text-success">
                            <i class="bi bi-check-circle" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card stat-card warning">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">{% trans "Laukia pasirašymo" %}</h6>
                            <h3 class="mb-0 text-warning">{{ pending_instructions }}</h3>
                        </div>
                        <div class="text-warning">
                            <i class="bi bi-clock-history" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card stat-card danger">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-1">{% trans "Praleista" %}</h6>
                            <h3 class="mb-0 text-danger">{{ expired_instructions }}</h3>
                        </div>
                        <div class="text-danger">
                            <i class="bi bi-exclamation-triangle" style="font-size: 2rem;"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pending Instructions Section -->
    {% if pending_instructions > 0 %}
    <div class="row mb-4">
        <div class="col-12">
            <h4 class="mb-3">
                <i class="bi bi-exclamation-circle text-warning"></i> 
                {% trans "Laukia jūsų pasirašymo" %}
            </h4>
        </div>

        <!-- Darbų saugos instrukcijos -->
        {% if object_list %}
        <div class="col-lg-6 mb-3">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-shield-check"></i> {% trans "Darbų saugos instrukcijos" %}
                    <span class="badge bg-light text-dark float-end">{{ object_list|length }}</span>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
                        {% for instruction in object_list %}
                        <a href="#" data-instruction-uuid="{{ instruction.uuid }}" class="instruction-sign-link list-group-item list-group-item-action d-flex justify-content-between align-items-center text-decoration-none text-dark">
                            <span>
                                <i class="bi bi-file-text text-primary"></i> 
                                {{ instruction.instruction.name }}
                            </span>
                            <span class="badge bg-warning">{% trans "Pasirašyti" %}</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Priešgaisrinės instrukcijos -->
        {% if priesrines_instrukcijos %}
        <div class="col-lg-6 mb-3">
            <div class="card h-100">
                <div class="card-header bg-danger text-white">
                    <i class="bi bi-fire"></i> {% trans "Priešgaisrinės instrukcijos" %}
                    <span class="badge bg-light text-dark float-end">{{ priesrines_instrukcijos|length }}</span>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
                        {% for instrukcija in priesrines_instrukcijos %}
                        <a href="#" data-priesgaisrinis-uuid="{{ instrukcija.uuid }}" class="priesgaisrinis-sign-link list-group-item list-group-item-action d-flex justify-content-between align-items-center text-decoration-none text-dark">
                            <span>
                                <i class="bi bi-file-text text-danger"></i> 
                                {{ instrukcija.instruction.pavadinimas }}
                            </span>
                            <span class="badge bg-warning">{% trans "Pasirašyti" %}</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Civilinės saugos instrukcijos -->
        {% if civiline_sauga %}
        <div class="col-lg-6 mb-3">
            <div class="card h-100">
                <div class="card-header bg-warning text-dark">
                    <i class="bi bi-shield-exclamation"></i> {% trans "Civilinės saugos instrukcijos" %}
                    <span class="badge bg-dark float-end">{{ civiline_sauga|length }}</span>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
                        {% for civiline in civiline_sauga %}
                        <a href="#" data-civiline-uuid="{{ civiline.uuid }}" class="civiline-sign-link list-group-item list-group-item-action d-flex justify-content-between align-items-center text-decoration-none text-dark">
                            <span>
                                <i class="bi bi-file-text text-warning"></i> 
                                {{ civiline.instruction.pavadinimas }}
                            </span>
                            <span class="badge bg-warning">{% trans "Pasirašyti" %}</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Mokymai -->
        {% if mokymo_instrukcijos %}
        <div class="col-lg-6 mb-3">
            <div class="card h-100">
                <div class="card-header bg-success text-white">
                    <i class="bi bi-book"></i> {% trans "Mokymai" %}
                    <span class="badge bg-light text-dark float-end">{{ mokymo_instrukcijos|length }}</span>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
                        {% for mokymas in mokymo_instrukcijos %}
                        <a href="#" data-mokymas-uuid="{{ mokymas.uuid }}" class="mokymas-sign-link list-group-item list-group-item-action d-flex justify-content-between align-items-center text-decoration-none text-dark">
                            <span>
                                <i class="bi bi-file-text text-success"></i> 
                                {{ mokymas.instruction.pavadinimas }}
                            </span>
                            <span class="badge bg-warning">{% trans "Pasirašyti" %}</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Kiti dokumentai -->
        {% if kitu_doc %}
        <div class="col-lg-6 mb-3">
            <div class="card h-100">
                <div class="card-header bg-info text-white">
                    <i class="bi bi-file-earmark-text"></i> {% trans "Kiti dokumentai" %}
                    <span class="badge bg-light text-dark float-end">{{ kitu_doc|length }}</span>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
                        {% for kitas_doc in kitu_doc %}
                        <a href="#" data-kitudoc-uuid="{{ kitas_doc.uuid }}" class="kitudoc-sign-link list-group-item list-group-item-action d-flex justify-content-between align-items-center text-decoration-none text-dark">
                            <span>
                                <i class="bi bi-file-text text-info"></i> 
                                {{ kitas_doc.instruction.pavadinimas }}
                            </span>
                            <span class="badge bg-warning">{% trans "Pasirašyti" %}</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- AAP -->
        {% if asmenines_apsaugos_priemones %}
        <div class="col-lg-6 mb-3">
            <div class="card h-100">
                <div class="card-header bg-secondary text-white">
                    <i class="bi bi-shield-fill-check"></i> {% trans "Asmeninės apsaugos priemonės" %}
                    <span class="badge bg-light text-dark float-end">{{ asmenines_apsaugos_priemones|length }}</span>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" style="max-height: 300px; overflow-y: auto;">
                        {% for AAP in asmenines_apsaugos_priemones %}
                        <a href="#" data-aap-uuid="{{ AAP.uuid }}" class="aap-sign-link list-group-item list-group-item-action d-flex justify-content-between align-items-center text-decoration-none text-dark">
                            <span>
                                <i class="bi bi-file-text text-secondary"></i> 
                                {{ AAP.AAP.pavadinimas }}
                            </span>
                            <span class="badge bg-warning">{% trans "Pasirašyti" %}</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
    {% else %}
    <!-- No pending instructions message -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-success" role="alert">
                <i class="bi bi-check-circle-fill"></i> 
                {% trans "Puiku! Šiuo metu neturite laukiančių pasirašymo instrukcijų." %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Supervisor Links Section -->
    {% if user.is_supervisor %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <i class="bi bi-briefcase"></i> {% trans "Vadybininko funkcijos" %}
                </div>
                <div class="card-body">
                    <div class="row g-2">
                        <div class="col-lg-3 col-md-4 col-sm-6">
                            <a href="{% url 'priminimai_administracijai' %}" class="btn btn-outline-dark w-100">
                                <i class="bi bi-bell"></i> {% trans "Administratoriaus atmintinė" %}
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6">
                            <a href="{% url 'user_add' %}" class="btn btn-outline-dark w-100">
                                <i class="bi bi-person-plus"></i> {% trans "Įtraukti naują darbuotoją" %}
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6">
                            <a href="{% url 'my_company_users' %}" class="btn btn-outline-dark w-100">
                                <i class="bi bi-people"></i> {% trans "Įmonės darbuotojai" %}
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6">
                            <a href="{% url 'darbu_saugos_zurnalas' %}" class="btn btn-outline-dark w-100">
                                <i class="bi bi-journal-text"></i> {% trans "Darbų saugos instruktavimo registras" %}
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6">
                            <a href="{% url 'priesgaisrinės_saugos_zurnalas' %}" class="btn btn-outline-dark w-100">
                                <i class="bi bi-fire"></i> {% trans "Priešgaisrinės saugos žurnalas" %}
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6">
                            <a href="{% url 'civiline_sauga_zurnalas' %}" class="btn btn-outline-dark w-100">
                                <i class="bi bi-shield-exclamation"></i> {% trans "Civilinės saugos žurnalas" %}
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6">
                            <a href="{% url 'mokymu_zurnalas' %}" class="btn btn-outline-dark w-100">
                                <i class="bi bi-book"></i> {% trans "Neformalus mokymas" %}
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6">
                            <a href="{% url 'kitu_doc_zurnalas' %}" class="btn btn-outline-dark w-100">
                                <i class="bi bi-file-earmark"></i> {% trans "Kiti dokumentai" %}
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6">
                            <a href="{% url 'AAP_zurnalas' %}" class="btn btn-outline-dark w-100">
                                <i class="bi bi-shield-check"></i> {% trans "Asmeninės apsaugos priemonės" %}
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6">
                            <a href="{% url 'sveikatos_tikrinimo_grafikas' %}" class="btn btn-outline-dark w-100">
                                <i class="bi bi-heart-pulse"></i> {% trans "Darbuotojų sveikatos tikrinimo grafikas" %}
                            </a>
                        </div>
                        <div class="col-lg-3 col-md-4 col-sm-6">
                            <a href="{% url 'dokumentai_list' %}" class="btn btn-outline-dark w-100">
                                <i class="bi bi-folder"></i> {% trans "Įmonės dokumentai" %}
                            </a>
                        </div>
                        {% if user.is_superuser %}
                        <div class="col-lg-3 col-md-4 col-sm-6">
                            <a href="{% url 'admin:index' %}" class="btn btn-outline-danger w-100">
                                <i class="bi bi-gear"></i> Admin
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- CSRF Token for AJAX requests -->
{% csrf_token %}

<!-- Universal Modal for All Instructions -->
<div class="modal fade" id="instructionModal" tabindex="-1" aria-labelledby="instructionModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-fullscreen-lg-down">
        <div class="modal-content">
            <div class="modal-header" id="modalHeader">
                <h5 class="modal-title" id="instructionModalLabel">
                    <i class="bi bi-file-text"></i> <span id="instructionTitle"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="instructionContent">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">{% trans "Kraunama..." %}</span>
                        </div>
                    </div>
                </div>
                <!-- PDF Viewer -->
                <div id="pdfContainer" class="mb-4" style="display:none;">
                    <iframe id="pdfViewer" style="width:100%; height:600px; border:1px solid #dee2e6;" class="pdf-viewer-responsive"></iframe>
                </div>
                
                <!-- Test Questions (if test exists) -->
                <div id="testContainer" style="display:none;">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <i class="bi bi-question-circle"></i> <span id="testTitle">Testas</span>
                        </div>
                        <div class="card-body" id="testQuestions">
                            <!-- Test questions will be inserted here -->
                        </div>
                    </div>
                </div>
                
                <!-- Agreement Checkbox -->
                <div class="form-check mt-4">
                    <input class="form-check-input" type="checkbox" id="agreeCheckbox">
                    <label class="form-check-label" for="agreeCheckbox">
                        {% trans "Su instrukcija susipažinau ir pasižadu jos laikytis." %}
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> {% trans "Uždaryti" %}
                </button>
                <button type="button" class="btn btn-success" id="signButton" disabled>
                    <i class="bi bi-check-circle"></i> {% trans "Pasirašyti" %}
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentUuid = null;
    let currentType = null;
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    const typeConfig = {
        'instruction': {
            apiUrl: '/api/user_instructions/',
            headerClass: 'bg-primary',
            successMsg: 'Instrukcija pasirašyta sėkmingai'
        },
        'priesgaisrinis': {
            apiUrl: '/api/priesgaisrinis/',
            headerClass: 'bg-danger',
            successMsg: 'Priešgaisrinė instrukcija pasirašyta sėkmingai'
        },
        'civiline': {
            apiUrl: '/api/civiline_sauga/',
            headerClass: 'bg-warning',
            successMsg: 'Civilinės saugos instrukcija pasirašyta sėkmingai'
        },
        'mokymas': {
            apiUrl: '/api/mokymu/',
            headerClass: 'bg-success',
            successMsg: 'Mokymas pasirašytas sėkmingai'
        },
        'kitudoc': {
            apiUrl: '/api/kitu_doc/',
            headerClass: 'bg-info',
            successMsg: 'Dokumentas pasirašytas sėkmingai'
        },
        'aap': {
            apiUrl: '/api/AAP/',
            headerClass: 'bg-secondary',
            successMsg: 'AAP pasirašyta sėkmingai'
        }
    };
    
    // Enable sign button when checkbox is checked
    document.getElementById('agreeCheckbox').addEventListener('change', function() {
        document.getElementById('signButton').disabled = !this.checked;
    });
    
    // Setup click handlers for all instruction types
    setupHandlers('.instruction-sign-link', 'data-instruction-uuid', 'instruction');
    setupHandlers('.priesgaisrinis-sign-link', 'data-priesgaisrinis-uuid', 'priesgaisrinis');
    setupHandlers('.civiline-sign-link', 'data-civiline-uuid', 'civiline');
    setupHandlers('.mokymas-sign-link', 'data-mokymas-uuid', 'mokymas');
    setupHandlers('.kitudoc-sign-link', 'data-kitudoc-uuid', 'kitudoc');
    setupHandlers('.aap-sign-link', 'data-aap-uuid', 'aap');
    
    function setupHandlers(selector, attribute, type) {
        document.querySelectorAll(selector).forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                const uuid = this.getAttribute(attribute);
                currentUuid = uuid;
                currentType = type;
                loadInstruction(uuid, type);
            });
        });
    }
    
    function loadInstruction(uuid, type) {
        const config = typeConfig[type];
        const modal = new bootstrap.Modal(document.getElementById('instructionModal'));
        const modalHeader = document.getElementById('modalHeader');
        
        // Set header color
        modalHeader.className = 'modal-header text-white ' + config.headerClass;
        
        modal.show();
        
        // Reset
        document.getElementById('agreeCheckbox').checked = false;
        document.getElementById('signButton').disabled = true;
        document.getElementById('instructionContent').innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">{% trans "Kraunama..." %}</span></div></div>';
        document.getElementById('pdfContainer').style.display = 'none';
        document.getElementById('testContainer').style.display = 'none';
        
        // Fetch instruction data
        fetch(`${config.apiUrl}${uuid}/sign/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('instructionTitle').textContent = data.title;
                    document.getElementById('instructionContent').innerHTML = '';
                    
                    if (data.pdf_url) {
                        // Use browser's native PDF viewer (simpler and more reliable)
                        const absolutePdfUrl = window.location.origin + data.pdf_url;
                        
                        // Load PDF directly with browser's native viewer
                        document.getElementById('pdfViewer').src = absolutePdfUrl + '#toolbar=1&navpanes=0&scrollbar=1';
                        document.getElementById('pdfContainer').style.display = 'block';
                    } else {
                        document.getElementById('instructionContent').innerHTML = '<div class="alert alert-warning">{% trans "PDF dokumentas nepridėtas" %}</div>';
                    }
                    
                    // Display test if exists
                    if (data.test) {
                        displayTest(data.test);
                    }
                } else {
                    document.getElementById('instructionContent').innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                }
            })
            .catch(error => {
                document.getElementById('instructionContent').innerHTML = `<div class="alert alert-danger">{% trans "Klaida kraunant duomenis" %}</div>`;
            });
    }
    
    function displayTest(testData) {
        const testContainer = document.getElementById('testContainer');
        const testQuestions = document.getElementById('testQuestions');
        const testTitle = document.getElementById('testTitle');
        
        testTitle.textContent = testData.title;
        testQuestions.innerHTML = '';
        
        testData.questions.forEach((question, index) => {
            const questionDiv = document.createElement('div');
            questionDiv.className = 'mb-4';
            questionDiv.innerHTML = `
                <h6 class="fw-bold">${index + 1}. ${question.question}</h6>
                <div class="ms-3">
                    ${question.answers.map(answer => `
                        <div class="form-check">
                            <input class="form-check-input test-answer" type="radio" 
                                   name="question_${question.id}" 
                                   value="${answer.id}" 
                                   id="answer_${answer.id}">
                            <label class="form-check-label" for="answer_${answer.id}">
                                ${answer.text}
                            </label>
                        </div>
                    `).join('')}
                </div>
            `;
            testQuestions.appendChild(questionDiv);
        });
        
        testContainer.style.display = 'block';
    }
    
    function collectTestAnswers() {
        const testContainer = document.getElementById('testContainer');
        if (testContainer.style.display === 'none') {
            return null; // No test
        }
        
        const answers = {};
        const radioButtons = document.querySelectorAll('.test-answer:checked');
        
        radioButtons.forEach(radio => {
            const questionId = radio.name.replace('question_', '');
            answers[questionId] = radio.value;
        });
        
        return answers;
    }
    
    // Handle signing
    document.getElementById('signButton').addEventListener('click', function() {
        if (!currentUuid || !currentType) return;
        
        // Collect test answers if test exists
        const testAnswers = collectTestAnswers();
        
        // Validate that all test questions are answered
        if (testAnswers !== null) {
            const testQuestions = document.querySelectorAll('[name^="question_"]');
            const uniqueQuestions = new Set();
            testQuestions.forEach(q => uniqueQuestions.add(q.name));
            
            if (Object.keys(testAnswers).length < uniqueQuestions.size) {
                alert('{% trans "Prašome atsakyti į visus klausimus" %}');
                return;
            }
        }
        
        const button = this;
        const config = typeConfig[currentType];
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>{% trans "Pasirašoma..." %}';
        
        const requestBody = testAnswers ? JSON.stringify({ test_answers: testAnswers }) : '';
        
        fetch(`${config.apiUrl}${currentUuid}/sign/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json',
            },
            body: requestBody
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('instructionModal')).hide();
                
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
                alertDiv.style.zIndex = '9999';
                alertDiv.innerHTML = `
                    <i class="bi bi-check-circle-fill"></i> ${config.successMsg}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(alertDiv);
                
                setTimeout(() => alertDiv.remove(), 3000);
                
                // Reload page to update counts
                setTimeout(() => location.reload(), 1000);
            } else {
                button.disabled = false;
                button.innerHTML = '<i class="bi bi-check-circle"></i> {% trans "Pasirašyti" %}';
                alert('{% trans "Klaida:" %} ' + data.error);
            }
        })
        .catch(error => {
            button.disabled = false;
            button.innerHTML = '<i class="bi bi-check-circle"></i> {% trans "Pasirašyti" %}';
            alert('{% trans "Klaida pasirašant" %}');
        });
    });
});
</script>
{% endblock %}
